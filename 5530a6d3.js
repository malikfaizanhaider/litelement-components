import{A as e}from"./797e236a.js";class t{constructor(e={}){this.warmUpDelay=1e3,this.coolDownDelay=1e3,this.isWarm=!1,this.timeout=0,Object.assign(this,e)}async openTimer(e){if(this.cancelCooldownTimer(),this.component&&e===this.component){if(this.promise)return this.promise;throw new Error("Inconsistent state")}return this.component&&(this.close(this.component),this.cancelCooldownTimer()),this.component=e,!this.isWarm&&(this.promise=new Promise(e=>{this.resolve=e,this.timeout=window.setTimeout(()=>{this.resolve&&(this.resolve(!1),this.isWarm=!0)},this.warmUpDelay)}),this.promise)}close(e){this.component&&this.component===e&&(this.resetCooldownTimer(),this.timeout>0&&(clearTimeout(this.timeout),this.timeout=0),this.resolve&&(this.resolve(!0),delete this.resolve),delete this.promise,delete this.component)}resetCooldownTimer(){this.isWarm&&(this.cooldownTimeout&&window.clearTimeout(this.cooldownTimeout),this.cooldownTimeout=window.setTimeout(()=>{this.isWarm=!1,delete this.cooldownTimeout},this.coolDownDelay))}cancelCooldownTimer(){this.cooldownTimeout&&window.clearTimeout(this.cooldownTimeout),delete this.cooldownTimeout}}class o{constructor(e,t,o){this.isOpen=!1,this.owner=e,this.overlayElement=o,this.interaction=t}static async open(e,t,i,n){const s=new o(e,t,i);return await s.open(n),()=>{s.close()}}static update(){const e=new CustomEvent("sp-update-overlays",{bubbles:!0,composed:!0,cancelable:!0});document.dispatchEvent(e)}async open({abortPromise:e,delayed:t,offset:i=0,placement:n="top",receivesFocus:s,notImmediatelyClosable:r}){if(this.isOpen)return!0;void 0===t&&(t=this.overlayElement.hasAttribute("delayed"));const a={color:void 0,scale:void 0},l=new CustomEvent("sp-query-theme",{bubbles:!0,composed:!0,detail:a,cancelable:!0});this.owner.dispatchEvent(l);const c={},d=new CustomEvent("sp-overlay-query",{bubbles:!0,composed:!0,detail:c,cancelable:!0});return this.overlayElement.dispatchEvent(d),await o.overlayStack.openOverlay({abortPromise:e,content:this.overlayElement,contentTip:c.overlayContentTipElement,delayed:t,offset:i,placement:n,trigger:this.owner,interaction:this.interaction,theme:a,receivesFocus:s,notImmediatelyClosable:r,...c}),this.isOpen=!0,!0}close(){o.overlayStack.closeOverlay(this.overlayElement)}}o.overlayStack=new class{constructor(){this.overlays=[],this.preventMouseRootClose=!1,this.root=document.body,this.handlingResize=!1,this.overlayTimer=new t,this.canTabTrap=!0,this.trappingInited=!1,this.handleMouseCapture=e=>{const t=this.topOverlay;if(e.target&&t&&t.overlayContent&&!function(e){return!!(e.metaKey||e.altKey||e.ctrlKey||e.shiftKey)}(e)&&function(e){return 0===e.button}(e)){if(e.target instanceof Node){if(e.composedPath().indexOf(t.overlayContent)>=0)return void(this.preventMouseRootClose=!0);this.preventMouseRootClose=!1}}else this.preventMouseRootClose=!0},this._doesNotCloseOnFirstClick=!1,this.handleMouse=e=>{this._doesNotCloseOnFirstClick?this._doesNotCloseOnFirstClick=!1:this.preventMouseRootClose||e.defaultPrevented||this.closeTopOverlay()},this.handleKeyUp=e=>{if("Escape"===e.code){const e=this.topOverlay;this.closeTopOverlay(),e&&e.trigger.focus()}},this.handleResize=()=>{this.handlingResize||(this.handlingResize=!0,requestAnimationFrame(async()=>{const e=this.overlays.map(e=>e.updateOverlayPosition());await Promise.all(e),this.handlingResize=!1}))},this.addEventListeners()}initTabTrapping(){if(this.document.body.shadowRoot)return void(this.canTabTrap=!1);if(this.document.body.attachShadow({mode:"open"}),!this.document.body.shadowRoot)return;const e=this.document.body.shadowRoot;e.innerHTML='\n            <div id="actual"><slot></slot></div>\n            <style>\n            #actual {\n                position: relative;\n                height: calc(100% - var(--swc-body-margins-block, 0px));\n                z-index: 0;\n                min-height: calc(100vh - var(--swc-body-margins-block, 0px));\n            }\n            #holder {\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                flex-flow: column;\n                height: 100%;\n                width: 100%;\n                top: 0;\n                left: 0;\n                position: fixed;\n            }\n            #holder[hidden] {\n                display: none !important;\n            }\n            #actual[tabindex="-1"] {\n                pointer-events: none;  /* just in case? */\n            }\n            </style>\n            <div id="holder" hidden><slot name="open"></slot></div>\n        ',this.tabTrapper=e.querySelector("#actual"),this.overlayHolder=e.querySelector("#holder"),this.tabTrapper.attachShadow({mode:"open"}),this.tabTrapper.shadowRoot&&(this.tabTrapper.shadowRoot.innerHTML="<slot></slot>")}startTabTrapping(){this.trappingInited||(this.initTabTrapping(),this.trappingInited=!0),this.canTabTrap&&(this.tabTrapper.tabIndex=-1,this.tabTrapper.setAttribute("aria-hidden","true"),this.overlayHolder.hidden=!1,requestAnimationFrame(()=>{const e=getComputedStyle(document.body);this.tabTrapper.style.setProperty("--swc-body-margins-inline",`calc(${e.marginLeft} + ${e.marginRight})`),this.tabTrapper.style.setProperty("--swc-body-margins-block",`calc(${e.marginTop} + ${e.marginBottom})`)}))}stopTabTrapping(){this.canTabTrap&&this.trappingInited&&(this.tabTrapper.removeAttribute("tabindex"),this.tabTrapper.removeAttribute("aria-hidden"),this.overlayHolder.hidden=!0)}get document(){return this.root.ownerDocument||document}get topOverlay(){return this.overlays.slice(-1)[0]}findOverlayForContent(e){for(const t of this.overlays)if(e===t.overlayContent)return t}addEventListeners(){this.document.addEventListener("click",this.handleMouseCapture,!0),this.document.addEventListener("click",this.handleMouse),this.document.addEventListener("keyup",this.handleKeyUp),window.addEventListener("resize",this.handleResize)}isClickOverlayActiveForTrigger(e){return this.overlays.some(t=>e===t.trigger&&"click"===t.interaction)}async openOverlay(t){if(this.findOverlayForContent(t.content))return!1;t.notImmediatelyClosable&&(this._doesNotCloseOnFirstClick=!0),"modal"===t.interaction&&this.startTabTrapping();const o=t.content;if(o.overlayWillOpenCallback){const{trigger:e}=t;o.overlayWillOpenCallback({trigger:e})}if(t.delayed){const e=[this.overlayTimer.openTimer(t.content)];t.abortPromise&&e.push(t.abortPromise);const i=await Promise.race(e);if(i){if(o.overlayOpenCancelledCallback){const{trigger:e}=t;o.overlayOpenCancelledCallback({trigger:e})}return i}}if("click"===t.interaction)this.closeAllHoverOverlays();else if("hover"===t.interaction&&this.isClickOverlayActiveForTrigger(t.trigger))return!0;const i=e.create(t);if(this.overlays.length){this.overlays[this.overlays.length-1].obscure(i.interaction)}return document.body.appendChild(i),new Promise(e=>requestAnimationFrame(e)).then(async()=>{if(this.overlays.push(i),await i.updateComplete,this.addOverlayEventListeners(i),void 0!==o.open&&(o.open=!0),o.overlayOpenCallback){const{trigger:e}=i;o.overlayOpenCallback({trigger:e})}return"auto"===t.receivesFocus&&i.focus(),t.trigger.dispatchEvent(new CustomEvent("sp-opened",{bubbles:!0,composed:!0,cancelable:!0,detail:{interaction:t.interaction}})),!1})}addOverlayEventListeners(e){switch(e.addEventListener("close",()=>{this.hideAndCloseOverlay(e)}),e.interaction){case"replace":this.addReplaceOverlayEventListeners(e);break;case"inline":this.addInlineOverlayEventListeners(e)}}addReplaceOverlayEventListeners(e){e.addEventListener("keydown",t=>{const{code:o}=t;"Tab"===o&&(t.stopPropagation(),this.closeOverlay(e.overlayContent),e.tabbingAway=!0,e.trigger.focus(),e.trigger.dispatchEvent(new KeyboardEvent("keydown",t)))})}addInlineOverlayEventListeners(e){e.trigger.addEventListener("keydown",e.handleInlineTriggerKeydown),e.addEventListener("keydown",t=>{const{code:o,shiftKey:i}=t;if("Tab"===o){if(e.tabbingAway=!0,i){const t=document.createElement("span");return t.tabIndex=-1,e.trigger.hasAttribute("slot")&&(t.slot=e.trigger.slot),e.trigger.insertAdjacentElement("afterend",t),t.focus(),void t.remove()}t.stopPropagation(),this.closeOverlay(e.overlayContent),e.trigger.focus()}})}closeOverlay(e){this.overlayTimer.close(e),requestAnimationFrame(()=>{const t=this.findOverlayForContent(e);this.hideAndCloseOverlay(t)})}closeAllHoverOverlays(){for(const e of this.overlays)"hover"===e.interaction&&this.hideAndCloseOverlay(e,!1)}async hideAndCloseOverlay(e,t){if(e){await e.hide(t);const o=e.overlayContent;if(void 0!==o.open&&(o.open=!1),o.overlayCloseCallback){const{trigger:t}=e;o.overlayCloseCallback({trigger:t})}if("dispose"!=e.state)return;const i=this.overlays.indexOf(e);if(i>=0&&this.overlays.splice(i,1),this.overlays.length){const e=this.overlays[this.overlays.length-1];e.feature(),"modal"===e.interaction||e.hasModalRoot?e.focus():this.stopTabTrapping()}else{if(this.stopTabTrapping(),"modal"===e.interaction||("replace"===e.interaction||"inline"===e.interaction)&&!e.tabbingAway){const t=e.overlayContent.getRootNode().activeElement,o=e.trigger.getRootNode(),i=o.activeElement;(e.overlayContent.contains(t)||e.trigger.getRootNode().contains(i)||o.host&&o.host===i)&&e.trigger.focus()}e.tabbingAway=!1}e.remove(),e.dispose(),e.trigger.dispatchEvent(new CustomEvent("sp-closed",{bubbles:!0,composed:!0,cancelable:!0,detail:{interaction:e.interaction}}))}}closeTopOverlay(){return this.hideAndCloseOverlay(this.topOverlay)}};export{o as Overlay};
